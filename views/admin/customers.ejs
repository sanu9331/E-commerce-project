<!doctype html>
<html lang="en">

<head>
    <title>customers</title>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

    <!-- Bootstrap CSS v5.2.1 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous" />
</head>

<body>
    <header>
        <!-- place navbar here -->
        <%- include('../layouts/adminHeader.ejs') %>
    </header>
    <main>

        <div class="container mt-4">
            <div class="row justify-content-center  ">
                <div class=" col-md-10 col-lg-10 ">
                    <h1 class="text-bg-info  rounded"
                        style="font-size: 30px; width: 230px; text-align: center;  font-family:Arial, Helvetica, sans-serif;">
                        Customer List</h1>
                    <div class="table-responsive">

                        <div class="overflow-auto p-3 bg-light" style="max-width: 1500px; max-height: 600px;">


                            <table class="table  ">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Mobile</th>
                                        <th>Image</th>
                                        <th>Status</th>
                                        <th>view orders</th>
                                        <th style="text-align: center;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% customers.forEach(customer=> { %>
                                        <tr>
                                            <td>
                                                <%= customer.name%>
                                            </td>
                                            <td>
                                                <%= customer.email %>
                                            </td>
                                            <td>
                                                <%= customer.mobile %>
                                            </td>
                                            <!-- <td><img src="/images/userImages/<%= customer.image %>" alt="Customer Image"
                                                    width="50px">
                                            </td> -->
                                            <td>
                                                <% if (customer.image) { %>
                                                    <img src="/images/userImages/<%= customer.image %>"
                                                        alt="Customer Image" width="50px">
                                                    <% } else { %>
                                                        No Image
                                                        <% } %>
                                            </td>
                                            <td style="font-weight:bold;">
                                                <%= customer.status %>
                                            </td>

                                            <td>
                                                <!-- <a href="/orders?customerId=<%= customer._id %>" class="btn btn-info"
                                                    onclick="viewOrders('<%= customer._id %>','/admin/customers?id=')">View
                                                    Orders</a> -->
                                                <!-- <form action="/admin/orders" method="post">
                                                    <input type="hidden" name="userID" value="<%= customer._id %>">
                                                    <button type="submit">view orders</button>
                                                </form> -->
                                                <a href="/admin/orders?userID=<%= customer._id %>"
                                                    class="btn btn-outline-primary">View
                                                    Orders</a>


                                            </td>

                                            <td style="text-align: center; ">
                                                <a href="javascript:void(0);"
                                                    class="btn <%= customer.status.toString() === 'true' ? 'btn-outline-danger' : 'btn-outline-success' %>"
                                                    onclick="confirmBlockUnblock('<%= customer._id %>',
                                                        '<%= customer.status.toString() %>')">
                                                    <%= customer.status.toString()==='true' ? 'Block' : 'Unblock' %>
                                                </a>
                                                <!-- <a href="javascript:void(0);"
                                                    class="btn <%= customer.status ? 'btn-outline-danger' : 'btn-outline-success' %>"
                                                    onclick="confirmBlockUnblock('<%= customer._id %>', '<%= customer.status %>')">
                                                    <%= customer.status ? 'Block' : 'Unblock' %>
                                                </a> -->

                                                <a href="javascript:void(0);" class="btn btn-danger"
                                                    onclick="confirmDelete('<%= customer._id %>','/admin/customers?id=','You will not be able to recover this user!')">Delete</a>
                                            </td>

                                        </tr>
                                        <% }); %>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Pagination Section -->
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center">
                <% if (currentPage> 1) { %>
                    <li class="page-item">
                        <a class="page-link" href="/admin/customers?page=<%= currentPage - 1 %>" aria-label="Previous">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>
                    <% } %>

                        <% const maxPagesToShow=1; // Set the maximum number of pages to display %>
                            <% const startPage=Math.max(1, currentPage - maxPagesToShow); %>
                                <% const endPage=Math.min(totalPages, startPage + maxPagesToShow * 2 - 1); %>

                                    <% if (startPage> 1) { %>
                                        <li class="page-item disabled">
                                            <span class="page-link">...</span>
                                        </li>
                                        <% } %>

                                            <% for (let i=startPage; i <=endPage; i++) { %>
                                                <li class="page-item <%= i === currentPage ? 'active' : '' %>">
                                                    <a class="page-link" href="/admin/customers?page=<%= i %>">
                                                        <%= i %>
                                                    </a>
                                                </li>
                                                <% } %>

                                                    <% if (endPage < totalPages) { %>
                                                        <li class="page-item disabled">
                                                            <span class="page-link">...</span>
                                                        </li>
                                                        <% } %>

                                                            <% if (currentPage < totalPages) { %>
                                                                <li class="page-item">
                                                                    <a class="page-link"
                                                                        href="/admin/customers?page=<%= currentPage + 1 %>"
                                                                        aria-label="Next">
                                                                        <span aria-hidden="true">&raquo;</span>
                                                                    </a>
                                                                </li>
                                                                <% } %>
            </ul>
        </nav>

    </main>
    <script>
        function viewOrders(customerId) {
            window.location.href = `/orders?customerId=${customerId}`;
        }
    </script>
    <script>
        //delete operation
        function confirmDelete(customerId) {
            // Use a confirmation dialog
            if (confirm('Are you sure you want to delete this user?')) {
                // If the user confirms, redirect to the delete route
                window.location.href = '/admin/customers/delete/' + customerId;
            }
        }

        // block/unblock operation
        function confirmBlockUnblock(userId, currentStatus) {
            if (confirm('Are you sure you want to change the status of this user?')) {
                // Send a POST request to the server
                fetch('/admin/block-unblock-user', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ id: userId }),
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Optionally update the UI or perform additional actions on success
                            console.log(data.message);
                            location.reload(); // Reload the page after successful status update
                        } else {
                            // Handle error
                            console.error(data.message);
                        }
                    })
                    .catch(error => console.error('Error:', error));
            }
        }

    </script>

    <footer>
        <!-- place footer here -->
        <%- include('../layouts/adminFooter.ejs') %>
    </footer>

    <!-- Bootstrap JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
        integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
        crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"
        integrity="sha384-BBtl+eGJRgqQAUMxJ7pMwbEyER4l1g+O15P+16Ep7Q9Q+zqX6gSbd85u4mG4QzX+"
        crossorigin="anonymous"></script>
</body>

</html>